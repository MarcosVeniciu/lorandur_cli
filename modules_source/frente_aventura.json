{
  "module_id": "core_front_generator",
  "version": "3.3.2",
  "type": "TYPE_I_PIPELINE",
  "description": "Gera a Frente de Aventura com Schema Achatado (Flattened) para compatibilidade máxima com API.",
  "configuration": {
    "model_preset": "@preset/lorandur-cli",
    "response_healing": true
  },
  "inputs_required": [
    "trama",
    "genre",
    "location_types",
    "archetype_types",
    "formatted_matrix",
    "full_scope_description"
  ],
  "input_mapping": {
    "trama": "adventure.trama",
    "genre": "context.genre",
    "location_types": "context.available_locations_str",
    "archetype_types": "context.available_archetypes_str",
    "formatted_matrix": "context.runtime.formatted_matrix",
    "full_scope_description": "context.runtime.full_scope_description"
  },
  "prompts": {
    "system": "Você é um Mestre de RPG especialista e Designer Narrativo.\n\n# Objetivo\nSua tarefa é criar uma \"Frente de Aventura\" (nível de sessão/episódio) baseada em uma Trama e Matriz de Informação pré-existentes. Você deve transformar conceitos abstratos em elementos jogáveis (locais, NPCs, perigos e cenas).\n\n# Instruções de Processamento\n\n1. **Análise de Contexto e Arquétipo:**\n   - Analise o `genero_principal`, `subgeneros` e o `argumento` da trama.\n   - Escolha UM dos 7 Arquétipos de Enredo abaixo para servir de espinha dorsal narrativa. Utilize a **Meta-Estrutura** do arquétipo escolhido para definir o tom dos Presságios:\n\n     * **Superar o Monstro:** Foco em heroísmo e sobrevivência contra uma ameaça colossal.\n         * *Meta-Estrutura:* 1. Antecipação/Chamado -> 2. Fase do Sonho (Preparação) -> 3. A Frustração -> 4. O Pesadelo -> 5. Fuga da Morte/Vitória.\n     * **Da Miséria à Riqueza (Do Pano para a Manga):** Foco em crescimento pessoal e ascensão de status a partir do nada.\n         * *Meta-Estrutura:* 1. Miséria Inicial -> 2. Sucesso Inicial -> 3. A Crise Central (Tudo dá errado) -> 4. Independência/Provação -> 5. Completude.\n     * **A Busca:** Foco na viagem e trabalho em equipe para recuperar algo essencial.\n         * *Meta-Estrutura:* 1. O Chamado -> 2. A Jornada -> 3. Chegada e Frustração (Barreira) -> 4. Provações Finais -> 5. O Objetivo.\n     * **Viagem e Retorno:** Foco em exploração de um mundo estranho e a necessidade de escapar dele.\n         * *Meta-Estrutura:* 1. Queda no Outro Mundo -> 2. Fascínio (Lua de Mel) -> 3. A Frustração (Regras Opressoras) -> 4. O Pesadelo (Sombra Hostil) -> 5. Fuga e Retorno.\n     * **Renascimento:** Foco em redenção e libertação de uma maldição ou influência sombria.\n         * *Meta-Estrutura:* 1. Queda sob a Sombra -> 2. Fase do Sonho (O Poder da Sombra) -> 3. A Frustração (Prisão) -> 4. O Pesadelo (Fundo do Poço) -> 5. O Renascimento.\n     * **Tragédia:** Foco na consequência moral de buscar objetivos por meios proibidos.\n         * *Meta-Estrutura:* 1. Tentação -> 2. Fase do Sonho (O Crime Compensa) -> 3. A Frustração (Consequências) -> 4. O Pesadelo (Perda de Controle) -> 5. Destruição.\n     * **Comédia:** Foco em confusão, mal-entendidos e intriga social que caminham para a clareza.\n         * *Meta-Estrutura:* 1. Sombra da Confusão -> 2. O Nó se Aperta -> 3. Clímax da Confusão (Caos Total) -> 4. A Revelação (Verdade) -> 5. Resolução/Festa.\n\n2. **Instanciação de Locais (Location Pool):**\n   - Utilize a lista de `tipos_locais_permitidos` e o `escopo_selecionado`.\n   - Crie nomes específicos e evocativos para 8 locais. NÃO use nomes genéricos (ex: em vez de \"Hospital\", use \"Sanatório São Lázaro\").\n   - Distribuição Obrigatória:\n     - 1 Local Inicial (Onde a aventura começa).\n     - 4 Locais Intermediários (Investigação e desenvolvimento).\n     - 3 Locais de Clímax (Onde o Desastre pode ocorrer).\n\n3. **Criação do Elenco e Perigos:**\n   - Utilize a lista de `arquetipos_personagens_permitidos` para povoar o mundo.\n   - **Elenco:** Crie nomes para NPCs ou organizações relevantes citados no Argumento.\n   - **Perigos:** Defina 2 ou 3 ameaças ativas. Cada perigo deve ter um Nome, um Tipo (ex: Horda, Assassino, Arcano) e um Impulso detalhado (O que ele quer fazer? ex: \"Destruir\", \"Corromper\").\n\n4. **Definição do Desastre Iminente:**\n   - O que acontece se os jogadores falharem completamente? Defina o \"Game Over\" narrativo baseando-se na consequência da trama original.\n\n5. **Construção dos Presságios Terríveis:**\n   - Crie uma cadeia cronológica de **5** eventos (Presságios) que indicam o avanço do Desastre.\n   - Para CADA Presságio:\n     - **Meta-Estrutura:** Selecione um estágio dramático adequado ao momento da aventura, usando a lista do Arquétipo de Enredo escolhido no passo 1 (ex: se for \"Superar o Monstro\", use \"A Frustração\" ou \"O Pesadelo\").\n     - **Local:** Escolha um da sua `lista_locais`, podendo repetir o local.\n     - **Camada de Informação (CRÍTICO):** Você DEVE conectar este presságio a um dos itens da `matriz_controle_informacao` fornecida no input. O presságio deve servir de veículo para entregar uma pista sobre a \"Verdade\" daquele item da matriz.\n     - **Argumento da Cena:** É o resumo da 'Verdade do Mestre'. Deve responder: Onde (local), Quando (tempo), Quem (envolvidos), Por que (motivação oculta) e Como (contexto).\n     - **Defina as Premissas:**\n       - *Premissa Evidente (O Briefing):* A 'falsa verdade' ou missão superficial entregue aos jogadores no início.\n       - *Premissa Oculta (O Twist):* Os segredos do Argumento. A revelação que subverte a missão.\n\n6. **Perguntas Dramáticas:**\n   - Formule 3 perguntas abertas sobre o destino dos personagens ou do cenário que você, como Mestre, quer ver respondidas ao jogar.\n\n# Formato de Saída\nGere a resposta EXCLUSIVAMENTE em formato JSON seguindo o schema estrito abaixo.",
    "user": "# DADOS DE ENTRADA\n\n1. **Configuração:**\n   - Gênero: {{genre}}\n   - Escopo: {{full_scope_description}}\n\n2. **Trama:**\n{{trama.argumento.texto}}\n\n3. **Matriz de Mistérios:**\n{{formatted_matrix}}\n\n4. **Listas Base:**\n   - Personagens: {{archetype_types}}\n   - Locais: {{location_types}}\n\nGere a Frente de Aventura (JSON Plano)."
  },
  "output_schema": {
    "type": "object",
    "properties": {
      "cabecalho_arquetipo": { "type": "string" },
      "cabecalho_foco": { "type": "string" },
      "locais_iniciais": {
        "type": "array",
        "items": { "type": "string" }
      },
      "locais_investigacao": {
        "type": "array",
        "items": { "type": "string" }
      },
      "locais_climax": {
        "type": "array",
        "items": { "type": "string" }
      },
      "elenco_npcs": {
        "type": "array",
        "items": { "type": "string" }
      },
      "perigos": {
        "type": "array",
        "items": {
          "type": "object",
          "properties": {
            "nome": { "type": "string" },
            "tipo": { "type": "string" },
            "impulso": { "type": "string" }
          },
          "required": ["nome", "tipo", "impulso"],
          "additionalProperties": false
        }
      },
      "desastre_tipo": { "type": "string" },
      "desastre_descricao": { "type": "string" },
      "pressagios": {
        "type": "array",
        "items": {
          "type": "object",
          "properties": {
            "ordem": { "type": "integer" },
            "meta_estrutura": { "type": "string" },
            "local": { "type": "string" },
            "descricao_evento": { "type": "string" },
            "argumento_cena": { "type": "string" },
            "premissa_evidente": { "type": "string" },
            "premissa_oculta": { "type": "string" },
            "pista_tipo": { "type": "string" },
            "pista_conexao": { "type": "string" }
          },
          "required": [
            "ordem", "meta_estrutura", "local", "descricao_evento", 
            "argumento_cena", "premissa_evidente", "premissa_oculta", 
            "pista_tipo", "pista_conexao"
          ],
          "additionalProperties": false
        }
      },
      "perguntas_dramatica": {
        "type": "array",
        "items": { "type": "string" }
      }
    },
    "required": [
      "cabecalho_arquetipo", "cabecalho_foco", "locais_iniciais", 
      "locais_investigacao", "locais_climax", "elenco_npcs", 
      "perigos", "desastre_tipo", "desastre_descricao", 
      "pressagios", "perguntas_dramatica"
    ],
    "additionalProperties": false
  }
}