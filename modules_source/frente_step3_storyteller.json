{
  "module_id": "step3_front_storyteller",
  "version": "1.0.0",
  "type": "TYPE_I_PIPELINE",
  "description": "Passo 3/3: Cria os Mini-Arcos (Presságios) e Camadas de Realidade.",
  "configuration": {
    "model_preset": "@preset/lorandur-cli",
    "response_healing": true
  },
  "inputs_required": [
    "genre",
    "trama_argumento",
    "matriz",
    "step1_arquetipo",
    "step2_locais",
    "step2_npcs",
    "step2_perigos"
  ],
  "input_mapping": {
    "genre": "context.genre",
    "trama_argumento": "adventure.trama.argumento.texto",
    "matriz": "context.runtime.formatted_matrix",
    "step1_arquetipo": "adventure.front.step1.analise_arquetipica",
    "step2_locais": "adventure.front.step2.locais_definidos",
    "step2_npcs": "adventure.front.step2.elenco_npcs",
    "step2_perigos": "adventure.front.step2.perigos_ameacas"
  },
  "prompts": {
    "system": "Você é um Diretor Narrativo e Mestre de RPG (Sistema Dominus).\n\n# Objetivo\nEscrever 5 Presságios Terríveis em formato de Mini-Arcos, conectando a Estrutura (Step 1) e o Mundo (Step 2).\n\n# Conceito: Mini-Arco\nUm Presságio NÃO é uma cena estática. É um conflito em andamento. Descreva a situação problemática que os jogadores encontram.\n\n# Instruções Críticas\n1. **Uso de Assets:** Use OBRIGATORIAMENTE Locais, NPCs e Perigos criados no Step 2.\n2. **Camadas de Realidade (Dominus):** Para cada presságio, defina:\n   - *Premissa Evidente:* O problema visível (Gancho).\n   - *Premissa Oculta:* A verdade por trás do problema (Twist/Conexão com a Matriz).\n   - *Justificativa Integrada:* Explique como o evidente esconde o oculto.\n3. **Narrativa Densa:** O campo 'descricao_mini_arco' deve ser um parágrafo rico e sensorial sobre o conflito.",
    "user": "# INPUTS\nGênero: {{genre}}\nTrama: {{trama_argumento}}\n\n# ESTRUTURA\nArquétipo: {{step1_arquetipo.arquetipo_selecionado}}\nFases: {{step1_arquetipo.meta_estrutura_fases}}\n\n# ASSETS DISPONÍVEIS\nLocais: {{step2_locais}}\nElenco: {{step2_npcs}}\nAmeaças: {{step2_perigos}}\n\n# SEGREDOS (MATRIZ)\n{{matriz}}\n\nEscreva os 5 Presságios (Mini-Arcos)."
  },
  "output_schema": {
    "type": "object",
    "properties": {
      "racional_narrativo_global": {
        "type": "string",
        "description": "Explicação macro de como a tensão escala do Presságio 1 ao 5."
      },
      "pressagios_sequencia": {
        "type": "array",
        "minItems": 5,
        "maxItems": 5,
        "items": {
          "type": "object",
          "properties": {
            "ordem": { "type": "integer" },
            "fase_meta_estrutura": { "type": "string", "description": "Ex: Fase do Sonho, A Frustração." },
            "local_selecionado": { "type": "string", "description": "Nome exato de um local do Step 2." },
            "titulo_pressagio": { "type": "string" },
            "descricao_mini_arco": { 
              "type": "string", 
              "description": "Um parágrafo denso descrevendo o CONFLITO ATIVO ou SITUAÇÃO em andamento neste local." 
            },
            "camadas_realidade": {
              "type": "object",
              "properties": {
                "justificativa_dualidade": { "type": "string", "description": "Racional que conecta o evidente ao oculto." },
                "premissa_evidente": { "type": "string", "description": "O gancho visível para os jogadores." },
                "premissa_oculta": { "type": "string", "description": "A verdade secreta/twist deste mini-arco." }
              },
              "required": ["justificativa_dualidade", "premissa_evidente", "premissa_oculta"]
            },
            "pista_matriz": { "type": "string", "description": "Qual item da Matriz é revelado/sugerido aqui." },
            "npc_chave": { "type": "string" }
          },
          "required": ["ordem", "fase_meta_estrutura", "local_selecionado", "titulo_pressagio", "descricao_mini_arco", "camadas_realidade", "pista_matriz"]
        }
      },
      "perguntas_dramaticas": {
        "type": "array",
        "items": { "type": "string" },
        "minItems": 3
      }
    },
    "required": ["racional_narrativo_global", "pressagios_sequencia", "perguntas_dramaticas"]
  }
}